{% extends "open_base.html" %}
{% block titlecontainer %}
  <div class="w3-quart"></div>
  <div class="w3-half">
{% endblock %}

{% block titleheader %}
  {{ lopsinfo }}
{% endblock %}
{% block refresh %}{% endblock %}
{% block titlemain %} <img id=menu_icon src="../static/icon_timing.png"> {{ lopsinfo }}{% endblock %}
{% block headercontainer %}{{ lopsinfo }} <img id=header_icon src="../static/icon_timing.png"> {% endblock %}
{% block menuitems %}
  <li class=dropdown id=topborder>
    <a href=javascript:void(0) class=dropbtn>Velg klasse</a>
    <div class=dropdown-content>
      <a href=raceplans?event_id={{ event_id }}>Alle</a>
      {% for klasse in raceclasses %}
        {% for ac_name in klasse.ageclasses %}
          <a href=raceplans?klasse={{ klasse.name }}&event_id={{ event_id }}>{{ ac_name }}</a>
        {% endfor %}
      {% endfor %}
    </div>
  </li>
  {% if username != "Gjest" %}
  <li id=topborder>
    <a href=/raceplans?event_id={{ event_id }}&action=edit_mode class=dropbtn>Rediger</a>
  </li>
  {% endif %}
{% endblock %}
{% block content %}
  <div id=spacer></div>
  <table>
    <tr>
      <td>
        <form action=/tasks method=get target=new>
          <input type="hidden" name=event_id value="{{ event_id }}">
          <input type="submit" name="to_tasks" value="  Tilbake til rennforberedelser  ">
        </form>
      </td>
      <td width=150 align=center>
        <ul>
          <li class=dropdown>
            <a href=javascript:void(0) class=dropbtn>Utskrift</a>
            <div class=dropdown-content>
                <a id="myPrint" target=_new onclick="result_gui_href('myPrint', 'print_lists?event_id={{ event_id }}&action=raceplan')" href=>Alle</a>
              {% for klasse in raceclasses %}
                  <a id="myPrint{{ klasse.name}}" target=_new onclick="result_gui_href('myPrint{{ klasse.name}}', 'print_lists?klasse={{ klasse.name }}&event_id={{ event_id }}&action=raceplan')" href=>{{ klasse.name}}</a>
              {% endfor %}
            </div>
          </li>
        </ul>
      </td>
    </tr>
  </table>

  <! --- Edit menu --->
  {% if  action == "edit_mode" %}
    <table>
      <tr id=headerblue align=right>
        <td>
          <form action=/raceplans method=get>
            <input type="hidden" name="event_id" value="{{ event_id }}">
            <input type="hidden" name=action value="edit_time">
            <input type="submit" name="edit_time" value="  Tilpass tidskjema  ">
          </form>
        </td>
        <td>
          <form action=/raceplans method=post>
            <input type="hidden" name="event_id" value="{{ event_id }}">
            <input type="submit" name="generate_raceplan" value="  Generer kjøreplan  ">
          </form>
        </td>
        <td>
          <form action=/raceplans method=post onsubmit="return confirm_delete();">
            <input type="hidden" name="event_id" value="{{ event_id }}">
            <input type="submit" name="delete_all" value="  Slett alle kjøreplaner  ">
          </form>
        </td>
    </table>
  {% endif %}
  <! --- End edit menu --->
  {% if raceplan_validation %}
    <div class="w3-container" id=info><br>&nbsp;<img width=15 src="../static/warning.png" title="Valideringsfeil">Valideringsfeil.<br>
      {% for key, value in raceplan_validation.items() %}
        Heat {{ key }}: {% for element in value %}{{ element }}{% endfor %}<br>
      {% endfor %}
      <br>
    </div>
  {% endif %}
  <! --- Display raceplan summary --->
  {% if action == "" %}
    <table>
      <tr id=headerblue>
        <td>Løpsklasse</td>
        <td>Kvartfinale start</td>
        <td>Semifinaler</td>
        <td>Finaler</td>
        <td>Antall deltakere</td>
      </tr>
      {% for raceclass in raceplan_summary %}
        {% if (valgt_klasse == "") or (valgt_klasse == raceclass.name) %}
          <tr>
            <td>{{ raceclass.name }}</td>
            <td>{{ raceclass.timeQ }}</td>
            <td>{{ raceclass.timeS }}</td>
            <td>{{ raceclass.timeF }}</td>
            <td>{{ raceclass.no_of_contestants }}</td>
          </tr>
        {% endif %}
      {% endfor %}
    </table>
  {% endif %}
  <! --- End Display raceplan summary --->

  <! --- Information --->
  {% if action == "edit_time" %}
    <div id=orange>Tilpass tidplan - merk at kun ett tidspunkt kan endres om gangen og at alle påfølgende heat vil bli justert tilsvarende.</div>
  {% elif action == "edit_order" %}
    <div id=orange>Endre rekkefølgen på heat. Skriv inn nye heatnummer på alle endringer, pass på at det ikke blir to heat på samme nummer. Starttidspunkt må endres etterpå.</div>
  {% endif %}
  <! --- End Information --->


  <! --- Raceplan list --->
  <div align=right>
    {% if action == "edit_order" %}
      <form action="/raceplans" method=post>
        <input type="hidden" name="event_id" value="{{ event_id }}">
        <input type="submit" name=update_order value="  Endre rekkefølge  ">
    {% endif %}
  </div>
  <table>
    <tr id=headerblue>
      <td>Start</td>
      {% if action == "edit_time" %}
        <td>Ny tid</td>
      {% endif %}
      <td>Løpsklasse</td>
      <td>Runde</td>
      <td>Ant løpere</td>
      <td>Videre til</td>
      <td>Heat</td>
      <td>
        {% if action == "edit_order" %}
          Endre til
        {% endif %}
      </td>
    </tr>
    {% for race in races %}
      {% if (valgt_klasse == "") or (valgt_klasse == race.raceclass) %}
        <tr>
          <td>{{ race.start_time[-8:] }}</td>
          {% if action == "edit_time" %}
            <td>
              <form action="/raceplans" method=post>
                <input type="hidden" name="event_id" value="{{ event_id }}">
                <input type=hidden name=order value="{{ race.order }}">
                <input type=text name="new_time" value="" pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}" size=8 required>
                <input type="submit" name=update_time value="  Lagre  ">
              </form>
            </td>
          {% endif %}
          <td>{{ race.raceclass }}</td>
          <td>
            {% if race.round == "Q" %}
              Kvartfinale {{ race.heat }}
            {% elif race.round == "S" %}
              Semifinale {{ race.index }}{{ race.heat }}
            {% elif race.round == "F" %}
              Finale {{ race.index }}
            {% elif race.round == "R1" %}
              Runde 1
            {% elif race.round == "R2" %}
              Runde 2
            {% endif %}
          </td>
          <td>{{ race.no_of_contestants }}</td>
          <td>{{ race.next_race }}</td>
          <td>
            {% if race.validation %}
              <img width=15 src="../static/warning.png" title="{{ race.validation }}">&nbsp;
            {% endif %}
            {{ race.order }}
          </td>
          <td>
            {% if  action == "edit_mode" %}
              <form action=/raceplans method=post>
                <input type="submit" name=delete_one value="  Slett  ">
                <input type="hidden" name="id" value="{{ race.id }}">
                <input type="hidden" name="event_id" value="{{ event_id }}">
              </form>
            {% elif action == "edit_order" %}
              <input type=number name=new_order_{{ race.id }} value="" min=1 max=999>
              <input type=hidden name=old_order_{{ race.id }} value="{{ race.order }}">
            {% endif %}
          </td>
        </tr>
      {% endif %}
    {% endfor %}
  </table>
  <div align=right>
    {% if action == "edit_order" %}
        <input type="submit" name=update_order value="  Lagre  ">
      </form>
    {% endif %}
  </div>
  <table>
    <tr>
      <td>
        <form action=/tasks method=get target=new>
          <input type="hidden" name=event_id value="{{ event_id }}">
          <input type="submit" name="to_tasks" value="  Tilbake til rennforberedelser  ">
        </form>
      </td>
    </tr>
  </table>
{% endblock %}
